<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Infojis - Sistema de gestión académica INFOJIS">
    <meta name="keywords" content="sistema escolar, gestión educativa, administración escolar, plataforma docente">
    <meta name="author" content="Infojis">
    <link rel="icon" type="image/png"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎓</text></svg>">
    <title>Infojis</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modo_oscuro.css') }}">
    <style>
        .medal-icon {
            font-size: 1.2rem;
            margin-right: 5px;
        }

        .gold {
            color: #FFD700;
        }

        .silver {
            color: #C0C0C0;
        }

        .bronze {
            color: #CD7F32;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #dee2e6;
        }

        .progress-thin {
            height: 6px;
        }

        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="app-container">

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            {% if current_user.rol == 'admin' %}
            {% include 'partials/sidebar-admin.html' %}
            {% elif current_user.rol == 'docente' %}
            {% include 'partials/sidebar-docente.html' %}
            {% else %}
            <div class="p-3 text-danger">Rol no reconocido: {{ current_user.rol }}</div>
            {% endif %}
        </nav>

        <!-- Overlay para cerrar sidebar en móviles -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <main class="main-content" id="main-content">
            {% include 'partials/messages-flask.html' %}
            {% include 'partials/header.html' %}

            <div class="container-fluid py-4">
                <!-- Card de filtros -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label">Grado:</label>
                                <select class="form-select" id="select-grado">
                                    <option value="todos" {% if not curso_seleccionado %}selected{% endif %}>Todos los
                                        grados</option>
                                    {% for curso in cursos %}
                                    <option value="{{ curso.id }}" {% if curso.id==curso_seleccionado %}selected{% endif
                                        %}>
                                        {{ curso.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-filter w-100" id="btn-filtrar">
                                    <i class="fas fa-filter me-1"></i> Filtrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card de resultados -->
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">
                                <i class="fas fa-trophy me-2 text-warning"></i>Ranking Académico
                            </h5>
                            <div class="text-muted small mt-1">
                                <span id="texto-resultados">Resultados para el período activo</span>
                            </div>
                        </div>
                        <div>
                            <button id="btn-exportar-pdf" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-file-pdf me-1"></i> Exportar PDF
                            </button>
                        </div>
                    </div>

                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="100">Posición</th>
                                        <th width="70">Foto</th>
                                        <th>Estudiante</th>
                                        <th>Grado</th>
                                        <th>Promedio</th>
                                        <th>Asignaturas</th>
                                        <th width="120">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-posiciones">
                                    <tr>
                                        <td colspan="7" class="text-center py-5 text-muted">
                                             <div class="d-flex flex-column align-items-center">
                                                <i class="fas fa-info-circle fa-2x mb-2"
                                                    style="font-size: 2rem;"></i>
                                                <p class="mb-0">
                                                    {% if not curso_seleccionado or not tipo_documento %}
                                                    No hay estudiantes para mostrar. Aplique filtros para ver los resultados.
                                                    {% else %}
                                                    No hay estudiantes matriculados en este curso
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                    <!-- Contenedor de paginación -->
                    <div id="pagination-container" class="p-3"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Detalles -->
    <div class="modal fade" id="modalDetalles" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Detalles Académicos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-4">
                        <img id="detalle-foto" src="" class="student-avatar me-3">
                        <div>
                            <h5 id="detalle-nombre" class="mb-0"></h5>
                            <div class="text-muted small">
                                <span id="detalle-documento"></span> |
                                <span id="detalle-curso" class="badge bg-primary"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6 class="d-inline-block">Promedio General:</h6>
                        <span id="detalle-promedio" class="badge bg-success ms-2"></span>
                        <div class="progress progress-thin mt-2">
                            <div id="detalle-progress" class="progress-bar" role="progressbar"></div>
                        </div>
                    </div>

                    <h6 class="mb-3">Calificaciones por asignatura:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Asignatura</th>
                                    <th width="100">Nota</th>
                                    <th width="120">Fecha</th>
                                    <th width="150">Observación</th>
                                </tr>
                            </thead>
                            <tbody id="detalle-calificaciones">
                                <!-- Contenido dinámico -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modo_oscuro.js') }}"></script>
    <script>
        const baseUrl = "{{ url_for('posiciones.obtener_datos_posiciones') }}";
        const baseUrlDetalles = "{{ url_for('posiciones.obtener_historial', matricula_id=0) }}".replace('/0', '');
    </script>
    <script src="{{ url_for('static', filename='js/views/informes/posiciones.js') }}"></script>

    <script>
        // Evento para exportar
        $('#btn-exportar-pdf').click(function () {
            const grado = $('#select-grado').val();
            let url = `${baseUrl.replace('/datos', '/exportar')}`; // El período es manejado por el backend
            if (grado && grado !== 'todos') {
                url += `?curso=${grado}`;
            }
            window.location.href = url;
        });
    </script>
</body>

</html>